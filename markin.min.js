const MarkinJS=function(){const t="0.0.1",e={generateUUID:()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)),clientToSVGPoint(t,e,i){const n=t.createSVGPoint();return n.x=e,n.y=i,n.matrixTransform(t.getScreenCTM().inverse())},clientToSVGDelta(t,i,n){const o=e.clientToSVGPoint(t,0,0),s=e.clientToSVGPoint(t,1,1);return{x:i*(s.x-o.x),y:n*(s.y-o.y)}},formatPoints(t){if(!t)return"";if(Array.isArray(t)){if(0===t.length)return"";if("object"==typeof t[0])return t.map(t=>`${t.x},${t.y}`).join(" ");{const e=[];for(let i=0;i<t.length;i+=2)i+1<t.length&&e.push(`${t[i]},${t[i+1]}`);return e.join(" ")}}return t},pointsToArray(t){if(!t)return[];if(Array.isArray(t)){if("object"==typeof t[0])return t;{const e=[];for(let i=0;i<t.length;i+=2)i+1<t.length&&e.push({x:t[i],y:t[i+1]});return e}}return t.trim().split(" ").map(t=>{const[e,i]=t.split(",").map(Number);return{x:e,y:i}})},getElementRole(t){if(!t)return null;const e=t.getAttribute("data-role");if(e)return e;const i=t.tagName.toLowerCase();return"g"===i?"group":i}};class i{constructor(t,e=1){this.svg=t,this.zoom=e}setZoom(t){this.zoom=t}createRect(t,e,i,n,o={}){const s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x",t),s.setAttribute("y",e),s.setAttribute("width",i),s.setAttribute("height",n);const a=o.strokeWidth||2;return s.setAttribute("data-base-stroke-width",a),s.setAttribute("stroke-width",a/this.zoom),Object.entries(o).forEach(([t,e])=>{if("strokeWidth"!==t){const i=t.replace(/([A-Z])/g,"-$1").toLowerCase();s.setAttribute(i,e)}}),s}createCircle(t,e,i,n={}){const o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("cx",t),o.setAttribute("cy",e);const s=i||5;o.setAttribute("data-base-radius",s),o.setAttribute("r",s/this.zoom);const a=n.strokeWidth||2;return o.setAttribute("data-base-stroke-width",a),o.setAttribute("stroke-width",a/this.zoom),Object.entries(n).forEach(([t,e])=>{if("strokeWidth"!==t){const i=t.replace(/([A-Z])/g,"-$1").toLowerCase();o.setAttribute(i,e)}}),o}createPolygon(t,i={}){const n=document.createElementNS("http://www.w3.org/2000/svg","polygon"),o=e.formatPoints(t);n.setAttribute("points",o);const s=i.strokeWidth||2;return n.setAttribute("data-base-stroke-width",s),n.setAttribute("stroke-width",s/this.zoom),Object.entries(i).forEach(([t,e])=>{if("strokeWidth"!==t){const i=t.replace(/([A-Z])/g,"-$1").toLowerCase();n.setAttribute(i,e)}}),n}createGroup(t={}){const e=document.createElementNS("http://www.w3.org/2000/svg","g");return Object.entries(t).forEach(([t,i])=>{const n=t.replace(/([A-Z])/g,"-$1").toLowerCase();e.setAttribute(n,i)}),e}createLine(t,e,i,n,o={}){const s=document.createElementNS("http://www.w3.org/2000/svg","line");s.setAttribute("x1",t),s.setAttribute("y1",e),s.setAttribute("x2",i),s.setAttribute("y2",n);const a=o.strokeWidth||2;return s.setAttribute("data-base-stroke-width",a),s.setAttribute("stroke-width",a/this.zoom),Object.entries(o).forEach(([t,e])=>{if("strokeWidth"!==t){const i=t.replace(/([A-Z])/g,"-$1").toLowerCase();s.setAttribute(i,e)}}),s}}class n{constructor(){this.listeners={}}on(t,e){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),this}off(t,e){return this.listeners[t]&&(e?this.listeners[t]=this.listeners[t].filter(t=>t!==e):delete this.listeners[t]),this}emit(t,e){return this.listeners[t]&&this.listeners[t].forEach(t=>t(e)),this}}class o{constructor(t){this.annotator=t,this.selectedElement=null,this.selectableTypes=["rect","circle","polygon","g"]}isSelectable(t){if(!t)return!1;if(t.hasAttribute("data-handle-type"))return!1;if("cross-indicator"===t.getAttribute("data-role"))return!1;if("mask-candidate"===t.getAttribute("data-role"))return!1;const e=t.tagName.toLowerCase();return this.selectableTypes.includes(e)}findSelectableElement(t){if(this.isSelectable(t))return t;let e=t?.parentElement;for(;e&&e!==this.annotator.svg;){if(this.isSelectable(e))return e;e=e.parentElement}return null}select(t){return!!t&&(this.selectedElement&&this.selectedElement!==t&&this.deselect(),this.selectedElement=t,this.highlightElement(t),this.annotator.handleManager.clearHandles(),this.annotator.events.emit("select",{element:t,type:t.tagName.toLowerCase(),data:this.annotator.getElementData(t)}),!0)}deselect(){if(!this.selectedElement)return!1;const t=this.selectedElement;return this.removeHighlight(t),this.annotator.handleManager.clearHandles(),this.selectedElement=null,this.annotator.events.emit("deselect",{element:t,type:t.tagName.toLowerCase()}),!0}getSelected(){return this.selectedElement}highlightElement(t){if(!t)return;const e=t.tagName.toLowerCase();if("circle"===e){if(t.hasAttribute("data-selected"))return;const e=t.hasAttribute("data-base-radius")?parseFloat(t.getAttribute("data-base-radius")):parseFloat(t.getAttribute("r"))*this.annotator.zoom;t.hasAttribute("data-base-radius")||t.setAttribute("data-base-radius",e),t._originalProps={baseRadius:e,fillOpacity:t.getAttribute("fill-opacity")||"0.5"};const i=3*e/this.annotator.zoom;t.setAttribute("r",i),t.setAttribute("fill-opacity","0.05"),t.setAttribute("data-selected","true"),this.annotator.handleManager.addCrossIndicator(t)}else if("g"===e){t.setAttribute("data-selected","true");const e=t.children;for(let t=0;t<e.length;t++){const i=e[t];if("rect"===i.tagName.toLowerCase()&&"bbox"===i.getAttribute("data-role")){i.setAttribute("stroke-dasharray","5,5"),i.setAttribute("data-selected","true");break}}}else t.setAttribute("stroke-dasharray","5,5"),t.setAttribute("data-selected","true")}removeHighlight(t){if(!t)return;const e=t.tagName.toLowerCase();if("circle"===e){if(t._originalProps){const e=t._originalProps.baseRadius/this.annotator.zoom;t.setAttribute("r",e),t.setAttribute("fill-opacity",t._originalProps.fillOpacity),delete t._originalProps}t.removeAttribute("data-selected")}else if("g"===e){t.removeAttribute("data-selected"),t.removeAttribute("data-has-selected-child");const e=t.children;for(let t=0;t<e.length;t++){const i=e[t];i.hasAttribute("data-selected")&&(i.removeAttribute("data-selected"),i.setAttribute("stroke-dasharray",""))}}else t.setAttribute("stroke-dasharray",""),t.removeAttribute("data-selected")}}class s{constructor(t,e={}){this.svg=document.getElementById(t),this.svg?(this.options={zoom:1,historyEnabled:!0,historyMaxStates:50,keyboardControls:!0,requireBbox:!1,requireSelectionToDrag:!0,bboxContainPolygon:!0,bboxContainKeypoints:!0,autoResizeBbox:!0,bindElements:!0,deletionRules:{bbox:["keypoint","polygon","group"],keypoint:[],polygon:["bbox"]},...e},this.enabled=!0,this.zoom=this.options.zoom,this.dragInfo=null,this.justFinishedDrag=!1,this.uuidRegistry={},this.events=new n,this.elementFactory=new i(this.svg,this.zoom),this.selection=new o(this),this.handleManager=new a(this),this.options.historyEnabled&&(this.history=new HistoryManager(this,this.options.historyMaxStates),this.history.saveState("initial")),this.boundHandleMouseMove=this.handleMouseMove.bind(this),this.boundHandleClick=this.handleClick.bind(this),this.boundHandleGlobalMouseMove=this.handleGlobalMouseMove.bind(this),this.boundHandleGlobalMouseUp=this.handleGlobalMouseUp.bind(this),this.boundHandleKeyDown=this.handleKeyDown.bind(this),this.initEvents(),console.log(`SVG Annotator initialized for ${t} with ${this.options.keyboardControls?"keyboard controls enabled":"keyboard controls disabled"}`)):console.error(`SVG element with id '${t}' not found`)}initEvents(){this.svg.addEventListener("mousemove",this.boundHandleMouseMove),this.svg.addEventListener("click",this.boundHandleClick),document.addEventListener("mousemove",this.boundHandleGlobalMouseMove),document.addEventListener("mouseup",this.boundHandleGlobalMouseUp),this.options.keyboardControls&&document.addEventListener("keydown",this.boundHandleKeyDown)}handleMouseMove(t){if(this.dragInfo)return;const i=t.clientX,n=t.clientY,o=document.elementFromPoint(i,n),s=this.selection.findSelectableElement(o);s?(this.svg.style.cursor="pointer",s===this.selection.getSelected()&&(this.svg.style.cursor="move"),this.events.emit("hoverelement",{element:s,type:s.tagName.toLowerCase(),position:e.clientToSVGPoint(this.svg,t.clientX,t.clientY)})):(this.svg.style.cursor="default",this.events.emit("hovercanvas",{position:e.clientToSVGPoint(this.svg,t.clientX,t.clientY)}))}handleClick(t){if(this.dragInfo||this.justFinishedDrag)return;const i=t.clientX,n=t.clientY,o=document.elementFromPoint(i,n);if(!o)return;if(o.hasAttribute("data-handle-type")||"cross-indicator"===o.getAttribute("data-role"))return;const s=this.selection.findSelectableElement(o);s?(this.selection.select(s),this.handleManager.showHandlesForElement(s),this.addDirectDragHandler(s)):this.selection.getSelected()&&(this.selection.deselect(),this.events.emit("canvasclick",{position:e.clientToSVGPoint(this.svg,t.clientX,t.clientY)}))}addDirectDragHandler(t){t&&(t._directDragHandler&&t.removeEventListener("mousedown",t._directDragHandler),t._directDragHandler=i=>{if(i.target.hasAttribute("data-handle-type"))return;if("cross-indicator"===i.target.getAttribute("data-role"))return;if(this.options.requireSelectionToDrag&&t!==this.selection.getSelected())return;i.stopPropagation();const n=e.clientToSVGPoint(this.svg,i.clientX,i.clientY);this.dragInfo={handle:null,handleType:"direct-move",index:-1,targetElement:t,startClientX:i.clientX,startClientY:i.clientY,lastClientX:i.clientX,lastClientY:i.clientY,startSVGX:n.x,startSVGY:n.y,originalData:this.getElementData(t)},console.log(`Starting direct drag of ${t.tagName.toLowerCase()}`),this.events.emit("dragstart",{element:t,type:t.tagName.toLowerCase(),handleType:"direct-move",position:n})},t.addEventListener("mousedown",t._directDragHandler))}handleGlobalMouseMove(t){if(!this.dragInfo)return;t.preventDefault();const i=e.clientToSVGPoint(this.svg,t.clientX,t.clientY),n=t.clientX-this.dragInfo.lastClientX,o=t.clientY-this.dragInfo.lastClientY;this.dragInfo.lastClientX=t.clientX,this.dragInfo.lastClientY=t.clientY;const{handleType:s,targetElement:a}=this.dragInfo,r=a.tagName.toLowerCase();"rect"===r?s.startsWith("corner-")?this.handleRectResize(n,o):"move"!==s&&"direct-move"!==s||this.handleRectMove(n,o):"polygon"===r?"vertex"===s?this.handlePolygonVertexDrag(i):"move"!==s&&"direct-move"!==s||this.handlePolygonMove(n,o):"circle"===r&&("move"!==s&&"direct-move"!==s||this.handleCircleMove(n,o)),this.events.emit("drag",{element:a,type:r,handleType:s,position:i,delta:e.clientToSVGDelta(this.svg,n,o)})}handleGlobalMouseUp(t){if(!this.dragInfo)return;const i=e.clientToSVGPoint(this.svg,t.clientX,t.clientY),n=this.dragInfo.targetElement,o=this.dragInfo.handleType;if(this.events.emit("dragend",{element:n,type:n.tagName.toLowerCase(),handleType:o,startPosition:{x:this.dragInfo.startSVGX,y:this.dragInfo.startSVGY},endPosition:i,data:this.getElementData(n)}),n){const t=i.x-this.dragInfo.startSVGX,e=i.y-this.dragInfo.startSVGY;if(0!==t||0!==e){this.events.emit("elementmoved",{element:n,type:n.tagName.toLowerCase(),deltaX:t,deltaY:e}),this.events.emit("annotationmodified",{element:n,type:n.tagName.toLowerCase(),modification:"position",data:this.getElementData(n)});let i="position";o.startsWith("corner-")?i="resize":"vertex"===o&&(i="vertex"),this.events.emit("annotationmodificationcomplete",{element:n,type:n.tagName.toLowerCase(),modificationType:i,handleType:o,data:this.getElementData(n)}),this.saveState(`move_${n.tagName.toLowerCase()}`)}}n&&(this.selection.select(n),this.handleManager.showHandlesForElement(n)),this.justFinishedDrag=!0,this.dragInfo=null,setTimeout(()=>{this.justFinishedDrag=!1},200)}handleKeyDown(t){if(!this.enabled)return;if("z"===t.key&&(t.ctrlKey||t.metaKey))return t.shiftKey?this.redo():this.undo(),void t.preventDefault();if(!this.enabled||!this.selection.selectedElement)return;const e=this.selection.getSelected();if(e)if("Delete"!==t.key&&"Backspace"!==t.key){if(t.key.startsWith("Arrow")){let i=1;t.shiftKey?i=10:(t.ctrlKey||t.metaKey)&&(i=.2);let n=0,o=0;switch(t.key){case"ArrowLeft":n=-i;break;case"ArrowRight":n=i;break;case"ArrowUp":o=-i;break;case"ArrowDown":o=i}t.preventDefault(),this.moveElementByDelta(e,n,o),this.events.emit("annotationmodificationcomplete",{element:e,type:e.tagName.toLowerCase(),modificationType:"position",handleType:"keyboard",data:this.getElementData(e)}),this.saveState(`keyboard_move_${e.tagName.toLowerCase()}`)}}else this.deleteSelectedElement()}moveElementByDelta(t,i,n){if(!t)return;const o=t.tagName.toLowerCase();if("rect"===o){const e=parseFloat(t.getAttribute("x")),o=parseFloat(t.getAttribute("y"));t.setAttribute("x",e+i),t.setAttribute("y",o+n),t===this.selection.getSelected()&&this.handleManager.updateRectHandlePositions(t),this.updateBoundElements(t,{x:i,y:n})}else if("polygon"===o){const o=t.getAttribute("points");if(!o)return;const s=e.pointsToArray(o).map(t=>({x:t.x+i,y:t.y+n}));t.setAttribute("points",e.formatPoints(s)),t===this.selection.getSelected()&&this.handleManager.updatePolygonHandlePositions(t,s),this.enforceContainment(t)}else if("circle"===o){const e=parseFloat(t.getAttribute("cx")),o=parseFloat(t.getAttribute("cy"));t.setAttribute("cx",e+i),t.setAttribute("cy",o+n),t===this.selection.getSelected()&&this.handleManager.updateCircleHandlePosition(t),t.hasAttribute("data-selected")&&this.handleManager.updateCrossIndicator(t),this.enforceContainment(t)}else"g"===o&&Array.from(t.children).forEach(t=>{t.hasAttribute("data-handle-type")||"cross-indicator"===t.getAttribute("data-role")||this.moveElementByDelta(t,i,n)});this.events.emit("elementmoved",{element:t,type:t.tagName.toLowerCase(),deltaX:i,deltaY:n})}deleteSelectedElement(){const t=this.selection.getSelected();t&&(this.deleteElement(t),this.selection.deselect(),this.handleManager.clearHandles())}deleteElement(t){if(!t)return;const i={type:t.tagName.toLowerCase(),role:e.getElementRole(t),uuid:t.getAttribute("data-uuid")||null,groupId:null},n=t.closest('g[data-annotation-group="true"]');if(n&&(i.groupId=n.getAttribute("data-group-id")||n.getAttribute("data-uuid")),this.events.emit("beforedelete",i),this.selection.getSelected()===t&&this.selection.deselect(),"g"===t.tagName.toLowerCase())return void this.deleteGroup(t);const o=t.getAttribute("id"),s=e.getElementRole(t);if(this.options.bindElements){let i="unbind",a=[];if(n){const t=n.getAttribute("data-deletion-rules");if(t)try{const e=JSON.parse(t);e[s]&&Array.isArray(e[s])&&e[s].length>0&&(i="delete",a=e[s])}catch(t){console.error("Error parsing deletion rules:",t)}}if(o){const t=this.svg.querySelectorAll(`[data-bound-to="${o}"]`);"delete"===i?t.forEach(t=>{if(t.parentNode){t.parentNode.removeChild(t);const e=t.getAttribute("data-uuid");e&&this.uuidRegistry&&this.uuidRegistry[e]&&delete this.uuidRegistry[e]}}):t.forEach(t=>{t.removeAttribute("data-bound-to")})}if(t.hasAttribute("data-bound-to")){const i=t.getAttribute("data-bound-to"),n=this.svg.querySelector(`#${i}`);if(n&&a.length>0){const t=e.getElementRole(n);if(a.includes(t)&&n.parentNode){n.parentNode.removeChild(n);const t=n.getAttribute("data-uuid");t&&this.uuidRegistry&&this.uuidRegistry[t]&&delete this.uuidRegistry[t]}}}}t.parentNode&&(t.parentNode.removeChild(t),n&&this.cleanupGroupIfNeeded(n)),this.events.emit("delete",i),this.events.emit("annotationmodified",{type:i.type,modification:"delete",data:i}),this.events.emit("annotationmodificationcomplete",{type:i.type,modificationType:"delete",data:i});const a=t.getAttribute("data-uuid");a&&this.uuidRegistry&&this.uuidRegistry[a]&&delete this.uuidRegistry[a],this.saveState("delete_element")}cleanupGroupIfNeeded(t){if(!t)return;if(0===t.children.length)return void this.deleteGroup(t);let e=!1;for(let i=0;i<t.children.length;i++){const n=t.children[i];if(!n.hasAttribute("data-handle-type")&&("cross-indicator"!==n.getAttribute("data-role")&&"handle"!==n.getAttribute("data-role"))){e=!0;break}}e||this.deleteGroup(t)}deleteGroup(t){if(!t)return;const e=t.getAttribute("data-uuid");this.events.emit("beforedeletegroup",{group:t,groupId:e}),Array.from(t.querySelectorAll("[id]")).forEach(e=>{const i=e.getAttribute("id");if(i){this.svg.querySelectorAll(`[data-bound-to="${i}"]`).forEach(e=>{e.closest('g[data-annotation-group="true"]')!==t&&e.removeAttribute("data-bound-to")})}}),t.parentNode&&t.parentNode.removeChild(t),e&&this.uuidRegistry&&this.uuidRegistry[e]&&delete this.uuidRegistry[e],this.events.emit("deletegroup",{groupId:e})}getElementData(t){if(!t)return null;const i=t.tagName.toLowerCase();if("polygon"===i){const i=t.getAttribute("points");return i?{type:"polygon",points:e.pointsToArray(i),id:t.getAttribute("id")||"",role:t.getAttribute("data-role")||"polygon"}:{type:"polygon",points:[]}}return"rect"===i?{type:"rect",x:parseFloat(t.getAttribute("x")),y:parseFloat(t.getAttribute("y")),width:parseFloat(t.getAttribute("width")),height:parseFloat(t.getAttribute("height")),id:t.getAttribute("id")||"",role:t.getAttribute("data-role")||"rect"}:"circle"===i?{type:"circle",cx:parseFloat(t.getAttribute("cx")),cy:parseFloat(t.getAttribute("cy")),r:parseFloat(t.getAttribute("r")),id:t.getAttribute("id")||"",label:t.getAttribute("data-label")||"",role:t.getAttribute("data-role")||"circle"}:"g"===i?{type:"group",uuid:t.getAttribute("data-uuid")||"",class:t.getAttribute("data-class")||"",childCount:t.children.length}:null}createAnnotation(t={}){const i={...{uuid:e.generateUUID(),class:"",x:100,y:100,width:200,height:150,fill:"rgba(0, 0, 255, 0.2)",stroke:"#0000FF",requireBbox:this.options.requireBbox,bboxContainPolygon:this.options.bboxContainPolygon,bboxContainKeypoints:this.options.bboxContainKeypoints,bindElements:this.options.bindElements,containRules:[],deletionRules:this.options.deletionRules},...t},n=this.elementFactory.createGroup({"data-annotation-group":"true","data-uuid":i.uuid,"data-class":i.class});i.id&&n.setAttribute("id",i.id),this.uuidRegistry[i.uuid]={type:"group",element:n},i.deletionRules&&n.setAttribute("data-deletion-rules",JSON.stringify(i.deletionRules));let o=null;if(i.requireBbox||i.bbox){if(i.bbox){const[t,e,n,s]=i.bbox;o=this.elementFactory.createRect(t,e,n-t,s-e,{fill:i.fill,stroke:i.stroke,fillOpacity:.3,strokeOpacity:.8,class:"BboxElement",vectorEffect:"non-scaling-stroke","data-role":"bbox",id:`bbox-${i.uuid}`})}else o=this.elementFactory.createRect(i.x,i.y,i.width,i.height,{fill:i.fill,stroke:i.stroke,fillOpacity:.3,strokeOpacity:.8,class:"BboxElement",vectorEffect:"non-scaling-stroke","data-role":"bbox",id:`bbox-${i.uuid}`});this.uuidRegistry[`bbox-${i.uuid}`]={type:"rect",element:o},i.bindElements&&i.containRules&&i.containRules.length>0?o.setAttribute("data-contain",i.containRules.join(",")):i.bindElements&&i.bboxContainPolygon&&i.bboxContainKeypoints&&o.setAttribute("data-contain","polygon,keypoint"),n.appendChild(o)}let s=null;return i.segmentation&&i.segmentation.length>=6&&(s=this.createPolygonFromSegmentation(i.segmentation,{fill:i.fill,stroke:i.stroke,fillOpacity:.3,strokeOpacity:.8,vectorEffect:"non-scaling-stroke",class:"PolygonElement","data-role":"polygon",id:`polygon-${i.uuid}`}),this.uuidRegistry[`polygon-${i.uuid}`]={type:"polygon",element:s},o&&i.bindElements?s.setAttribute("data-bound-to",o.getAttribute("id")):i.bindElements||s.setAttribute("data-ignore-containment","true"),n.appendChild(s)),i.keypoints&&i.keypoints.length>0&&i.keypoints.forEach((t,e)=>{if(!t.point||2!==t.point.length)return;const[s,a]=t.point,r=t.name||`keypoint-${e}`,l=this.elementFactory.createCircle(s,a,5,{fill:"#FFFFFF",stroke:i.stroke,fillOpacity:.7,strokeOpacity:.8,vectorEffect:"non-scaling-stroke",class:"KeypointElement","data-role":"keypoint","data-label":r,id:`keypoint-${r}-${i.uuid}`});this.uuidRegistry[`keypoint-${r}-${i.uuid}`]={type:"circle",element:l},o&&i.bindElements?l.setAttribute("data-bound-to",o.getAttribute("id")):i.bindElements||l.setAttribute("data-ignore-containment","true"),n.appendChild(l),this.addDirectDragHandler(l)}),this.selection.select(n),this.handleManager.showHandlesForElement(n),n.parentNode||this.svg.appendChild(n),this.events.emit("annotationcreated",{group:n,uuid:i.uuid,class:i.class}),this.saveState("create_annotation"),n}createPolygonFromSegmentation(t,e={}){const i=[];for(let e=0;e<t.length;e+=2)e+1<t.length&&i.push({x:t[e],y:t[e+1]});return this.elementFactory.createPolygon(i,e)}enable(){this.enabled||(this.enabled=!0,this.initEvents(),this.events.emit("enabled",{message:"Annotator enabled"}))}disable(){this.enabled&&(this.selection.deselect(),this.svg.removeEventListener("mousemove",this.boundHandleMouseMove),this.svg.removeEventListener("click",this.boundHandleClick),document.removeEventListener("mousemove",this.boundHandleGlobalMouseMove),document.removeEventListener("mouseup",this.boundHandleGlobalMouseUp),this.options.keyboardControls&&document.removeEventListener("keydown",this.boundHandleKeyDown),this.enabled=!1,this.events.emit("disabled",{message:"Annotator disabled"}))}setZoom(t){"number"!=typeof t||t<=0?console.error("Invalid zoom level. Must be a positive number."):(this.zoom=t,this.elementFactory.setZoom(t),this.refreshElementsForZoom(),this.events.emit("zoomchange",{zoom:t}))}refreshZoom(){return this.refreshElementsForZoom(),this}refreshElementsForZoom(){this.svg.querySelectorAll("rect, circle, polygon, line").forEach(t=>{const e=t.tagName.toLowerCase();if(t.hasAttribute("data-handle-type")||"cross-indicator"===t.getAttribute("data-role"))return;const i=t.hasAttribute("data-base-stroke-width")?parseFloat(t.getAttribute("data-base-stroke-width")):2;if(t.hasAttribute("data-base-stroke-width")||t.setAttribute("data-base-stroke-width",i),t.setAttribute("stroke-width",i/this.zoom),"circle"===e){const e=t.hasAttribute("data-base-radius")?parseFloat(t.getAttribute("data-base-radius")):parseFloat(t.getAttribute("r"))*this.zoom;if(t.hasAttribute("data-base-radius")||t.setAttribute("data-base-radius",e),t.setAttribute("r",e/this.zoom),t.hasAttribute("data-selected")&&t._originalProps){const e=3*t._originalProps.baseRadius/this.zoom;t.setAttribute("r",e),this.handleManager.updateCrossIndicator(t)}}});const t=this.selection.getSelected();t&&this.handleManager.updateHandlePositions(t),this.handleManager.scaleHandlesForZoom(this.zoom)}getSelectedElement(){const t=this.selection.getSelected();return t?{element:t,type:t.tagName.toLowerCase(),data:this.getElementData(t),uuid:t.getAttribute("data-uuid")||null,class:t.getAttribute("data-class")||null}:null}handleRectMove(t,i){const{targetElement:n}=this.dragInfo,o=e.clientToSVGDelta(this.svg,t,i),s=parseFloat(n.getAttribute("x")),a=parseFloat(n.getAttribute("y"));n.setAttribute("x",s+o.x),n.setAttribute("y",a+o.y),this.handleManager.updateRectHandlePositions(n),this.updateBoundElements(n,o)}handlePolygonMove(t,i){const{targetElement:n}=this.dragInfo,o=e.clientToSVGDelta(this.svg,t,i),s=n.getAttribute("points");if(!s)return;const a=e.pointsToArray(s).map(t=>({x:t.x+o.x,y:t.y+o.y}));n.setAttribute("points",e.formatPoints(a)),n===this.selection.getSelected()&&this.handleManager.updatePolygonHandlePositions(n,a),this.updateBoundElements(n,o),this.enforceContainment(n),this.events.emit("annotationmodified",{element:n,type:n.tagName.toLowerCase(),modification:"position",data:this.getElementData(n)})}handlePolygonVertexDrag(t){const{targetElement:i,index:n}=this.dragInfo,o=e.pointsToArray(i.getAttribute("points"));o[n]={x:t.x,y:t.y};const s=e.formatPoints(o);i.setAttribute("points",s),this.handleManager.updatePolygonHandlePositions(i,o),this.enforceContainment(i),this.events.emit("annotationmodified",{element:i,type:i.tagName.toLowerCase(),modification:"vertex",vertexIndex:n,data:this.getElementData(i)})}handleCircleMove(t,i){const{targetElement:n}=this.dragInfo,o=e.clientToSVGDelta(this.svg,t,i),s=parseFloat(n.getAttribute("cx")),a=parseFloat(n.getAttribute("cy"));n.setAttribute("cx",s+o.x),n.setAttribute("cy",a+o.y),this.handleManager.updateCircleHandlePosition(n),n.hasAttribute("data-selected")&&this.handleManager.updateCrossIndicator(n),this.enforceContainment(n),this.events.emit("annotationmodified",{element:n,type:n.tagName.toLowerCase(),modification:"position",data:this.getElementData(n)})}handleRectResize(t,i){const{handleType:n,targetElement:o}=this.dragInfo,s=e.clientToSVGDelta(this.svg,t,i),a=parseFloat(o.getAttribute("x")),r=parseFloat(o.getAttribute("y")),l=parseFloat(o.getAttribute("width")),d=parseFloat(o.getAttribute("height")),h=a,c=r,u=l,g=d;let b=a,p=r,m=l,y=d;switch(n){case"corner-tl":b=a+s.x,p=r+s.y,m=l-s.x,y=d-s.y;break;case"corner-tr":p=r+s.y,m=l+s.x,y=d-s.y;break;case"corner-bl":b=a+s.x,m=l-s.x,y=d+s.y;break;case"corner-br":m=l+s.x,y=d+s.y}if(m>0&&y>0){o.setAttribute("x",b),o.setAttribute("y",p),o.setAttribute("width",m),o.setAttribute("height",y),this.handleManager.updateRectHandlePositions(o);const t={originalX:h,originalY:c,originalWidth:u,originalHeight:g,newX:b,newY:p,newWidth:m,newHeight:y,deltaX:b-h,deltaY:p-c,scaleX:m/u,scaleY:y/g};this.updateBoundElementsOnResize(o,t),b===h&&p===c||this.events.emit("elementmoved",{element:o,type:o.tagName.toLowerCase(),deltaX:b-h,deltaY:p-c}),this.events.emit("annotationmodified",{element:o,type:o.tagName.toLowerCase(),modification:"resize",data:this.getElementData(o)})}}updateBoundElements(t,i){if(!this.options.bindElements)return;const n=t.getAttribute("id");if(!n)return;this.svg.querySelectorAll(`[data-bound-to="${n}"]`).forEach(t=>{const n=t.tagName.toLowerCase();if("circle"===n){const e=parseFloat(t.getAttribute("cx")),n=parseFloat(t.getAttribute("cy"));t.setAttribute("cx",e+i.x),t.setAttribute("cy",n+i.y),t.hasAttribute("data-selected")&&this.handleManager.updateCrossIndicator(t)}else if("polygon"===n){const n=t.getAttribute("points");if(!n)return;const o=e.pointsToArray(n).map(t=>({x:t.x+i.x,y:t.y+i.y}));t.setAttribute("points",e.formatPoints(o))}else if("rect"===n){const e=parseFloat(t.getAttribute("x")),n=parseFloat(t.getAttribute("y"));t.setAttribute("x",e+i.x),t.setAttribute("y",n+i.y)}this.selection.getSelected()===t&&this.handleManager.updateHandlePositions(t)})}updateBoundElementsOnResize(t,i){if(!this.options.bindElements)return;const n=t.getAttribute("id");if(!n)return;const{originalX:o,originalY:s,originalWidth:a,originalHeight:r,newX:l,newY:d,newWidth:h,newHeight:c,deltaX:u,deltaY:g,scaleX:b,scaleY:p}=i;this.svg.querySelectorAll(`[data-bound-to="${n}"]`).forEach(t=>{const i=t.tagName.toLowerCase();if("circle"===i){const e=parseFloat(t.getAttribute("cx")),i=parseFloat(t.getAttribute("cy")),n=u+o+(e-o)/a*a*b,l=g+s+(i-s)/r*r*p;t.setAttribute("cx",n),t.setAttribute("cy",l),t.hasAttribute("data-selected")&&this.handleManager.updateCrossIndicator(t)}else if("polygon"===i){const i=t.getAttribute("points");if(!i)return;const n=e.pointsToArray(i).map(t=>{const e=(t.x-o)/a,i=(t.y-s)/r;return{x:u+o+e*a*b,y:g+s+i*r*p}});t.setAttribute("points",e.formatPoints(n))}this.selection.getSelected()===t&&this.handleManager.updateHandlePositions(t)}),this.enforceContainment(t)}enforceContainment(t){if(t.hasAttribute("data-ignore-containment"))return;const i=this.svg.querySelectorAll("[data-contain]");if(!i||0===i.length)return;const n=t.tagName.toLowerCase(),o=t.getAttribute("data-role");i.forEach(i=>{const s=i.getAttribute("data-contain").split(","),a=i.tagName.toLowerCase();let r=!1;if((o&&s.includes(o)||"circle"===n&&s.includes("keypoint")||"polygon"===n&&s.includes("polygon"))&&(r=!0),!r)return;if(t.closest("[data-annotation-group]")!==i.closest("[data-annotation-group]"))return;let l;if("rect"===a)l={x:parseFloat(i.getAttribute("x")),y:parseFloat(i.getAttribute("y")),width:parseFloat(i.getAttribute("width")),height:parseFloat(i.getAttribute("height"))};else if("polygon"===a){const t=e.pointsToArray(i.getAttribute("points")),n=Math.min(...t.map(t=>t.x)),o=Math.min(...t.map(t=>t.y)),s=Math.max(...t.map(t=>t.x)),a=Math.max(...t.map(t=>t.y));l={x:n,y:o,width:s-n,height:a-o}}if(l){if("circle"===n){const e=parseFloat(t.getAttribute("cx")),i=parseFloat(t.getAttribute("cy")),n=parseFloat(t.getAttribute("r")),o=Math.min(Math.max(e,l.x+n),l.x+l.width-n),s=Math.min(Math.max(i,l.y+n),l.y+l.height-n);o===e&&s===i||(t.setAttribute("cx",o),t.setAttribute("cy",s),t.hasAttribute("data-selected")&&this.handleManager.updateCrossIndicator(t))}else if("polygon"===n){const i=t.getAttribute("points");if(!i)return;const n=e.pointsToArray(i);let o=!1;if(n.forEach(t=>{(t.x<l.x||t.x>l.x+l.width||t.y<l.y||t.y>l.y+l.height)&&(o=!0)}),o){const i=Math.min(...n.map(t=>t.x)),o=Math.min(...n.map(t=>t.y)),s=Math.max(...n.map(t=>t.x)),a=Math.max(...n.map(t=>t.y));let r=0,d=0;i<l.x?r=l.x-i:s>l.x+l.width&&(r=l.x+l.width-s),o<l.y?d=l.y-o:a>l.y+l.height&&(d=l.y+l.height-a);const h=n.map(t=>({x:t.x+r,y:t.y+d}));t.setAttribute("points",e.formatPoints(h))}}else if("rect"===n){const e=parseFloat(t.getAttribute("x")),i=parseFloat(t.getAttribute("y")),n=parseFloat(t.getAttribute("width")),o=parseFloat(t.getAttribute("height")),s=Math.min(Math.max(e,l.x),l.x+l.width-n),a=Math.min(Math.max(i,l.y),l.y+l.height-o);s===e&&a===i||(t.setAttribute("x",s),t.setAttribute("y",a))}this.selection.getSelected()===t&&this.handleManager.updateHandlePositions(t)}})}enableKeyboardControls(){this.options.keyboardControls||(this.options.keyboardControls=!0,document.addEventListener("keydown",this.boundHandleKeyDown),console.log("Keyboard controls enabled"),this.events.emit("keyboardcontrolsenabled",{}))}saveState(t="unknown"){this.options.historyEnabled&&this.history&&this.history.saveState(t)}undo(){return!(!this.options.historyEnabled||!this.history)&&this.history.undo()}redo(){return!(!this.options.historyEnabled||!this.history)&&this.history.redo()}clearHistory(){this.options.historyEnabled&&this.history&&this.history.clearHistory()}disableKeyboardControls(){this.options.keyboardControls&&(this.options.keyboardControls=!1,document.removeEventListener("keydown",this.boundHandleKeyDown),console.log("Keyboard controls disabled"),this.events.emit("keyboardcontrolsdisabled",{}))}refreshReferences(){this.initEvents(),this.handleManager.clearHandles(),this.selection.annotator=this,this.elementFactory.svg=this.svg}exportAnnotation(t){if(!t||"g"!==t.tagName.toLowerCase())return console.error("Invalid annotation group provided"),null;const i={uuid:t.getAttribute("data-uuid")||e.generateUUID(),class:t.getAttribute("data-class")||"",type:"annotation"},n=t.querySelector('rect[data-role="bbox"]');n&&(i.bbox={x:parseFloat(n.getAttribute("x")),y:parseFloat(n.getAttribute("y")),width:parseFloat(n.getAttribute("width")),height:parseFloat(n.getAttribute("height")),id:n.getAttribute("id")||""});const o=t.querySelector('polygon[data-role="polygon"]');if(o){const t=o.getAttribute("points"),n=t?e.pointsToArray(t):[],s=[];n.forEach(t=>{s.push(t.x),s.push(t.y)}),i.segmentation=s,i.polygon={points:n,id:o.getAttribute("id")||""}}const s=t.querySelectorAll('circle[data-role="keypoint"]');s.length>0&&(i.keypoints=[],s.forEach(t=>{i.keypoints.push({name:t.getAttribute("data-label")||"",id:t.getAttribute("id")||"",point:[parseFloat(t.getAttribute("cx")),parseFloat(t.getAttribute("cy"))],visible:!0})}));const a=t.getAttributeNames();return a.length>0&&(i.attributes={},a.forEach(e=>{["data-uuid","data-class","data-annotation-group"].includes(e)||(i.attributes[e]=t.getAttribute(e))})),i}normalizeCoordinates(t,e,i){if(!t||!e||!i)return t;const n=JSON.parse(JSON.stringify(t));if(n.annotations&&Array.isArray(n.annotations))n.annotations.forEach(t=>{if(t.bbox&&(t.bbox.x=t.bbox.x/e,t.bbox.y=t.bbox.y/i,t.bbox.width=t.bbox.width/e,t.bbox.height=t.bbox.height/i,t.bbox.normalized=!0),t.polygon&&t.polygon.points&&(t.polygon.points=t.polygon.points.map(t=>({x:t.x/e,y:t.y/i})),t.polygon.normalized=!0),t.segmentation&&Array.isArray(t.segmentation)){for(let n=0;n<t.segmentation.length;n+=2)n+1<t.segmentation.length&&(t.segmentation[n]=t.segmentation[n]/e,t.segmentation[n+1]=t.segmentation[n+1]/i);t.segmentation_normalized=!0}t.keypoints&&Array.isArray(t.keypoints)&&(t.keypoints.forEach(t=>{t.point&&2===t.point.length&&(t.point=[t.point[0]/e,t.point[1]/i])}),t.keypoints_normalized=!0)});else if("annotation"===n.type){if(n.bbox&&(n.bbox.x=n.bbox.x/e,n.bbox.y=n.bbox.y/i,n.bbox.width=n.bbox.width/e,n.bbox.height=n.bbox.height/i,n.bbox.normalized=!0),n.polygon&&n.polygon.points&&(n.polygon.points=n.polygon.points.map(t=>({x:t.x/e,y:t.y/i})),n.polygon.normalized=!0),n.segmentation&&Array.isArray(n.segmentation)){for(let t=0;t<n.segmentation.length;t+=2)t+1<n.segmentation.length&&(n.segmentation[t]=n.segmentation[t]/e,n.segmentation[t+1]=n.segmentation[t+1]/i);n.segmentation_normalized=!0}n.keypoints&&Array.isArray(n.keypoints)&&(n.keypoints.forEach(t=>{t.point&&2===t.point.length&&(t.point=[t.point[0]/e,t.point[1]/i])}),n.keypoints_normalized=!0)}return n.normalized=!0,n.normalization_width=e,n.normalization_height=i,n}exportAllAnnotations(e={}){const i=this.svg.querySelectorAll('g[data-annotation-group="true"]'),n=[];i.forEach(t=>{const e=this.exportAnnotation(t);e&&n.push(e)});const o={type:"annotations",version:t,count:n.length,annotations:n};if(e.normalize){const t=this.svg.viewBox.baseVal,i=e.width||(t?t.width:this.svg.width.baseVal.value),n=e.height||(t?t.height:this.svg.height.baseVal.value);return this.normalizeCoordinates(o,i,n)}return o}exportSelectedAnnotation(t={}){const e=this.selection.getSelected();if(!e)return console.warn("No element selected"),null;let i;if("g"===e.tagName.toLowerCase()&&"true"===e.getAttribute("data-annotation-group"))i=this.exportAnnotation(e);else{const t=e.closest('g[data-annotation-group="true"]');i=t?this.exportAnnotation(t):{type:"element",data:this.getElementData(e)}}if(i&&t.normalize){const e=this.svg.viewBox.baseVal,n=t.width||(e?e.width:this.svg.width.baseVal.value),o=t.height||(e?e.height:this.svg.height.baseVal.value);return this.normalizeCoordinates(i,n,o)}return i}getAnnotationsAsJSON(t={}){const e=this.exportAllAnnotations();if(t&&t.normalize){const i=this.svg.viewBox.baseVal,n=t.width||(i?i.width:this.svg.width.baseVal.value),o=t.height||(i?i.height:this.svg.height.baseVal.value);e.annotations&&Array.isArray(e.annotations)&&(e.normalized=!0,e.normalization_width=n,e.normalization_height=o,e.annotations.forEach(t=>{if(t.bbox&&(t.bbox.x=t.bbox.x/n,t.bbox.y=t.bbox.y/o,t.bbox.width=t.bbox.width/n,t.bbox.height=t.bbox.height/o,t.bbox.normalized=!0),t.polygon&&t.polygon.points&&(t.polygon.points=t.polygon.points.map(t=>({x:t.x/n,y:t.y/o})),t.polygon.normalized=!0),t.segmentation&&Array.isArray(t.segmentation)){for(let e=0;e<t.segmentation.length;e+=2)e+1<t.segmentation.length&&(t.segmentation[e]=t.segmentation[e]/n,t.segmentation[e+1]=t.segmentation[e+1]/o);t.segmentation_normalized=!0}t.keypoints&&Array.isArray(t.keypoints)&&(t.keypoints.forEach(t=>{t.point&&2===t.point.length&&(t.point=[t.point[0]/n,t.point[1]/o])}),t.keypoints_normalized=!0)}))}return JSON.stringify(e,null,2)}getSelectedAnnotationAsJSON(t={}){const e=this.exportSelectedAnnotation();if(!e)return null;if(t&&t.normalize){const i=this.svg.viewBox.baseVal,n=t.width||(i?i.width:this.svg.width.baseVal.value),o=t.height||(i?i.height:this.svg.height.baseVal.value);if(e.normalized=!0,e.normalization_width=n,e.normalization_height=o,e.bbox&&(e.bbox.x=e.bbox.x/n,e.bbox.y=e.bbox.y/o,e.bbox.width=e.bbox.width/n,e.bbox.height=e.bbox.height/o,e.bbox.normalized=!0),e.polygon&&e.polygon.points&&(e.polygon.points=e.polygon.points.map(t=>({x:t.x/n,y:t.y/o})),e.polygon.normalized=!0),e.segmentation&&Array.isArray(e.segmentation)){for(let t=0;t<e.segmentation.length;t+=2)t+1<e.segmentation.length&&(e.segmentation[t]=e.segmentation[t]/n,e.segmentation[t+1]=e.segmentation[t+1]/o);e.segmentation_normalized=!0}e.keypoints&&Array.isArray(e.keypoints)&&(e.keypoints.forEach(t=>{t.point&&2===t.point.length&&(t.point=[t.point[0]/n,t.point[1]/o])}),e.keypoints_normalized=!0)}return JSON.stringify(e,null,2)}setRequireSelectionToDrag(t){this.options.requireSelectionToDrag=!!t,this.events.emit("requireselectiontodragchanged",{requireSelectionToDrag:this.options.requireSelectionToDrag})}deselect(){this.selection.deselect()}getOptions(){return{...this.options}}addKeypoint(t,e,i,n,o={}){let s;if(t)s="g"===t.tagName.toLowerCase()?t:t.closest('g[data-annotation-group="true"]');else{const t=this.selection.getSelected();if(!t)return console.error("No element selected and no element provided"),null;s="g"===t.tagName.toLowerCase()?t:t.closest('g[data-annotation-group="true"]')}if(!s||!s.getAttribute("data-annotation-group"))return console.error("Cannot find valid annotation group"),null;const a=s.getAttribute("data-uuid");if(!a)return console.error("Annotation group missing UUID"),null;const r={fill:o.fill||"#FFFFFF",stroke:o.stroke||"#0000FF",fillOpacity:o.fillOpacity||.7,strokeOpacity:o.strokeOpacity||.8,bindElement:void 0!==o.bindElement?o.bindElement:this.options.bindElements,...o},l=s.querySelector('rect[data-role="bbox"]'),d=this.elementFactory.createCircle(i,n,5,{fill:r.fill,stroke:r.stroke,fillOpacity:r.fillOpacity,strokeOpacity:r.strokeOpacity,vectorEffect:"non-scaling-stroke",class:"KeypointElement","data-role":"keypoint","data-label":e,id:`keypoint-${e}-${a}`});return this.uuidRegistry[`keypoint-${e}-${a}`]={type:"circle",element:d},l&&r.bindElement?d.setAttribute("data-bound-to",l.getAttribute("id")):r.bindElement||d.setAttribute("data-ignore-containment","true"),s.appendChild(d),this.addDirectDragHandler(d),this.saveState("add_keypoint"),this.events.emit("keypointadded",{element:d,name:e,position:{x:i,y:n},group:s}),this.events.emit("annotationmodificationcomplete",{element:d,type:"circle",modificationType:"add_keypoint",data:this.getElementData(d)}),d}updateAnnotation(t={}){let e=null;if(t.element&&t.element.tagName)e="g"===t.element.tagName.toLowerCase()?t.element:t.element.closest('g[data-annotation-group="true"]');else if(t.id){if(e=this.svg.getElementById(t.id),!e){const i=this.svg.querySelector(`#${t.id}`);i&&(e=i.closest('g[data-annotation-group="true"]'))}}else t.uuid&&(e=this.svg.querySelector(`g[data-uuid="${t.uuid}"]`));if(!e)return console.error("No existing annotation found to update"),null;const i=e.getAttribute("data-uuid"),n=e,o=e.parentNode,s=e.nextSibling,a={uuid:i,...t};e.hasAttribute("id")&&(a.id=e.getAttribute("id")),t.id&&!e.hasAttribute("id")&&(a._groupId=t.id);const r=this.selection.getSelected()===e;r&&this.selection.deselect(),o.removeChild(e);const l=this.createAnnotation(a);return a._groupId&&l.setAttribute("id",a._groupId),s&&o.insertBefore(l,s),r&&(this.selection.select(l),this.handleManager.showHandlesForElement(l)),this.saveState("update_annotation"),this.events.emit("annotationupdated",{uuid:i,id:l.getAttribute("id"),group:l,oldGroup:n}),l}}class a{constructor(t){this.annotator=t,this.handles=[],this.handleRadius=4}clearHandles(){this.handles.forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)});this.annotator.svg.querySelectorAll('[data-handle-type], [data-role="cross-indicator"]').forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)}),this.handles=[]}showHandlesForElement(t){if(!t)return;const e=t.tagName.toLowerCase();if("polygon"===e)this.showPolygonVertices(t);else if("rect"===e)this.showRectHandles(t);else if("circle"===e)this.showCircleHandles(t);else if("g"===e){const e=t.children;if(e.length>0){const i=e[0];"rect"===i.tagName.toLowerCase()&&"bbox"===i.getAttribute("data-role")&&(t.setAttribute("data-has-selected-child","true"),i.setAttribute("data-selected","true"),i.setAttribute("stroke-dasharray","5,5"),this.showRectHandles(i))}}}showRectHandles(t){const e=parseFloat(t.getAttribute("x")),i=parseFloat(t.getAttribute("y")),n=parseFloat(t.getAttribute("width")),o=parseFloat(t.getAttribute("height"));this.createHandle(e,i,0,t,"corner-tl"),this.createHandle(e+n,i,1,t,"corner-tr"),this.createHandle(e,i+o,2,t,"corner-bl"),this.createHandle(e+n,i+o,3,t,"corner-br")}showPolygonVertices(t){const i=t.getAttribute("points");if(!i)return;e.pointsToArray(i).forEach((e,i)=>{this.createHandle(e.x,e.y,i,t,"vertex")})}showCircleHandles(t){this.addCrossIndicator(t)}createHandle(t,e,i,n,o="vertex"){const s=document.createElementNS("http://www.w3.org/2000/svg","circle");s.setAttribute("cx",t),s.setAttribute("cy",e),s.setAttribute("r",this.handleRadius),s.setAttribute("fill","move"===o?"blue":"black"),s.setAttribute("fill-opacity","0.5"),s.setAttribute("stroke","white"),s.setAttribute("stroke-width",1),s.setAttribute("vector-effect","non-scaling-stroke"),s.setAttribute("data-index",i),s.setAttribute("data-handle-type",o),s.setAttribute("pointer-events","all"),s.setAttribute("class","HandleElement"),"vertex"===o||"move"===o?s.setAttribute("cursor","move"):"corner-tl"===o||"corner-br"===o?s.setAttribute("cursor","nwse-resize"):"corner-tr"!==o&&"corner-bl"!==o||s.setAttribute("cursor","nesw-resize");let a=n.parentElement;return a&&"g"===a.tagName.toLowerCase()||(a=this.annotator.svg),a.appendChild(s),this.handles.push(s),this.addHandleDragListeners(s,n,o),s}addHandleDragListeners(t,i,n){t.addEventListener("mousedown",o=>{o.stopPropagation(),o.preventDefault();const s=e.clientToSVGPoint(this.annotator.svg,o.clientX,o.clientY);this.annotator.selection.select(i),i.parentNode&&"g"===i.parentNode.tagName.toLowerCase()&&(i.parentNode.removeAttribute("data-selected"),i.parentNode.setAttribute("data-has-selected-child","true"),i.setAttribute("data-selected","true"),"circle"!==i.tagName.toLowerCase()&&i.setAttribute("stroke-dasharray","5,5")),this.annotator.dragInfo={handle:t,handleType:n,index:parseInt(t.getAttribute("data-index")),targetElement:i,startClientX:o.clientX,startClientY:o.clientY,lastClientX:o.clientX,lastClientY:o.clientY,startSVGX:s.x,startSVGY:s.y,originalData:this.annotator.getElementData(i)},console.log(`Starting drag of ${n} handle for ${i.tagName.toLowerCase()}`),this.annotator.events.emit("dragstart",{element:i,type:i.tagName.toLowerCase(),handleType:n,position:s})})}calculatePolygonCenter(t){if(!t||0===t.length)return{x:0,y:0};let e=1/0,i=1/0,n=-1/0,o=-1/0;return t.forEach(t=>{e=Math.min(e,t.x),i=Math.min(i,t.y),n=Math.max(n,t.x),o=Math.max(o,t.y)}),{x:(e+n)/2,y:(i+o)/2}}addCrossIndicator(t){const e=parseFloat(t.getAttribute("cx")),i=parseFloat(t.getAttribute("cy")),n=parseFloat(t.getAttribute("r")),o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",e),o.setAttribute("y1",i-n),o.setAttribute("x2",e),o.setAttribute("y2",i+n),o.setAttribute("stroke","#000000"),o.setAttribute("stroke-width",1),o.setAttribute("stroke-opacity","0.35"),o.setAttribute("data-role","cross-indicator"),o.setAttribute("pointer-events","none");const s=document.createElementNS("http://www.w3.org/2000/svg","line");s.setAttribute("x1",e-n),s.setAttribute("y1",i),s.setAttribute("x2",e+n),s.setAttribute("y2",i),s.setAttribute("stroke","#000000"),s.setAttribute("stroke-width",1),s.setAttribute("stroke-opacity","0.35"),s.setAttribute("data-role","cross-indicator"),s.setAttribute("pointer-events","none");const a=t.parentNode;a.appendChild(o),a.appendChild(s),this.handles.push(o),this.handles.push(s)}updateRectHandlePositions(t){const e=parseFloat(t.getAttribute("x")),i=parseFloat(t.getAttribute("y")),n=parseFloat(t.getAttribute("width")),o=parseFloat(t.getAttribute("height"));this.handles.forEach(t=>{switch(t.getAttribute("data-handle-type")){case"corner-tl":t.setAttribute("cx",e),t.setAttribute("cy",i);break;case"corner-tr":t.setAttribute("cx",e+n),t.setAttribute("cy",i);break;case"corner-bl":t.setAttribute("cx",e),t.setAttribute("cy",i+o);break;case"corner-br":t.setAttribute("cx",e+n),t.setAttribute("cy",i+o)}})}updatePolygonHandlePositions(t,i){if(!i){const n=t.getAttribute("points");if(!n)return;i=e.pointsToArray(n)}this.handles.forEach(t=>{const e=t.getAttribute("data-handle-type"),n=parseInt(t.getAttribute("data-index"));"vertex"===e&&n>=0&&n<i.length&&(t.setAttribute("cx",i[n].x),t.setAttribute("cy",i[n].y))})}updateCircleHandlePosition(t){}updateCrossIndicator(t){const e=parseFloat(t.getAttribute("cx")),i=parseFloat(t.getAttribute("cy")),n=parseFloat(t.getAttribute("r"));this.handles.forEach(t=>{if("cross-indicator"===t.getAttribute("data-role")&&"line"===t.tagName.toLowerCase()){t.getAttribute("x1")===t.getAttribute("x2")?(t.setAttribute("x1",e),t.setAttribute("y1",i-n),t.setAttribute("x2",e),t.setAttribute("y2",i+n)):(t.setAttribute("x1",e-n),t.setAttribute("y1",i),t.setAttribute("x2",e+n),t.setAttribute("y2",i))}})}updateHandlePositions(t){if(!t)return;const e=t.tagName.toLowerCase();"rect"===e?this.updateRectHandlePositions(t):"polygon"===e?this.updatePolygonHandlePositions(t):"circle"===e&&(this.updateCircleHandlePosition(t),t.hasAttribute("data-selected")&&this.updateCrossIndicator(t))}scaleHandlesForZoom(t){this.handles.forEach(e=>{if("circle"===e.tagName.toLowerCase()&&e.hasAttribute("data-handle-type")){e.hasAttribute("data-base-radius")||e.setAttribute("data-base-radius",this.handleRadius);const i=parseFloat(e.getAttribute("data-base-radius")||this.handleRadius);e.setAttribute("r",i/t)}})}}return{version:t,createAnnotator:function(t,e={}){const i=new s(t,e);return{enable:i.enable.bind(i),disable:i.disable.bind(i),setZoom:i.setZoom.bind(i),enableKeyboardControls:i.enableKeyboardControls.bind(i),disableKeyboardControls:i.disableKeyboardControls.bind(i),getSelectedElement:i.getSelectedElement.bind(i),deselect:i.deselect.bind(i),deleteSelectedElement:i.deleteSelectedElement.bind(i),deleteElement:i.deleteElement.bind(i),deleteGroup:i.deleteGroup.bind(i),setDeletionRules:function(t){i.options.deletionRules=t},setRequireSelectionToDrag:i.setRequireSelectionToDrag.bind(i),on:i.events.on.bind(i.events),off:i.events.off.bind(i.events),createAnnotation:i.createAnnotation.bind(i),addKeypoint:i.addKeypoint.bind(i),updateAnnotation:i.updateAnnotation.bind(i),exportAnnotation:i.exportAnnotation.bind(i),exportAllAnnotations:i.exportAllAnnotations.bind(i),exportSelectedAnnotation:i.exportSelectedAnnotation.bind(i),getAnnotationsAsJSON:i.getAnnotationsAsJSON.bind(i),getSelectedAnnotationAsJSON:i.getSelectedAnnotationAsJSON.bind(i),saveState:i.saveState.bind(i),undo:i.undo.bind(i),redo:i.redo.bind(i),clearHistory:i.clearHistory.bind(i),history:i.history,getSVGElement:function(){return i.svg}}},createImageAnnotator:function(t,e={}){const i=document.getElementById(t);if(!i)return console.error(`Image element with id '${t}' not found`),null;const n=i.parentElement;if(!n)return console.error(`Image element with id '${t}' doesn't have a parent`),null;const o=document.createElement("div");o.style.position="relative",o.style.display="inline-block",o.style.lineHeight="0";const a=`viva-svg-${t}`;n.insertBefore(o,i),o.appendChild(i);const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("id",a),r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.pointerEvents="none",o.appendChild(r);const l=()=>{const t=i.naturalWidth,e=i.naturalHeight;r.removeAttribute("width"),r.removeAttribute("height"),r.style.width="100%",r.style.height="100%",r.setAttribute("viewBox",`0 0 ${t} ${e}`),r.style.pointerEvents="auto"};l(),i.complete||i.addEventListener("load",l),window.addEventListener("resize",l);const d=new s(a,e);return d.image=i,d.svgOverlay=r,d.updateSVGDimensions=l,{enable:d.enable.bind(d),disable:d.disable.bind(d),setZoom:d.setZoom.bind(d),enableKeyboardControls:d.enableKeyboardControls.bind(d),disableKeyboardControls:d.disableKeyboardControls.bind(d),getSelectedElement:d.getSelectedElement.bind(d),deselect:d.deselect.bind(d),deleteSelectedElement:d.deleteSelectedElement.bind(d),deleteElement:d.deleteElement.bind(d),deleteGroup:d.deleteGroup.bind(d),setDeletionRules:function(t){d.options.deletionRules=t},setRequireSelectionToDrag:d.setRequireSelectionToDrag.bind(d),on:d.events.on.bind(d.events),off:d.events.off.bind(d.events),createAnnotation:d.createAnnotation.bind(d),addKeypoint:d.addKeypoint.bind(d),updateAnnotation:d.updateAnnotation.bind(d),exportAnnotation:d.exportAnnotation.bind(d),exportAllAnnotations:d.exportAllAnnotations.bind(d),exportSelectedAnnotation:d.exportSelectedAnnotation.bind(d),getAnnotationsAsJSON:d.getAnnotationsAsJSON.bind(d),getSelectedAnnotationAsJSON:d.getSelectedAnnotationAsJSON.bind(d),saveState:d.saveState.bind(d),undo:d.undo.bind(d),redo:d.redo.bind(d),clearHistory:d.clearHistory.bind(d),history:d.history,getImageElement:function(){return i},getSVGElement:function(){return r},updateDimensions:l,getContainerElement:function(){return o}}}}}();console.log("MarkinJS loaded");class HistoryManager{constructor(t,e=50){this.annotator=t,this.maxStates=e,this.undoStack=[],this.redoStack=[]}saveState(t="unknown"){this.redoStack=[];const e=this.annotator.svg.cloneNode(!0);this.undoStack.push({state:e,action:t,timestamp:Date.now()}),this.undoStack.length>this.maxStates&&this.undoStack.shift()}undo(){if(this.undoStack.length<=1)return!1;const t=this.undoStack.pop();this.redoStack.push(t);const e=this.undoStack[this.undoStack.length-1];return this.applyState(e.state),!0}redo(){if(0===this.redoStack.length)return!1;const t=this.redoStack.pop();return this.undoStack.push(t),this.applyState(t.state),!0}applyState(t){const e=this.annotator.enabled;this.annotator.disable();this.annotator.svg.parentNode.replaceChild(t,this.annotator.svg),this.annotator.svg=t,this.annotator.refreshReferences(),e&&this.annotator.enable()}hasUndo(){return this.undoStack.length>1}hasRedo(){return this.redoStack.length>0}clearHistory(){this.undoStack=[],this.redoStack=[],this.saveState("initial")}}